# 数据库迁移最佳实践

## 迁移文件命名规则

迁移文件应使用以下命名格式：
```
YYYYMMDD_descriptive_name.sql
```

例如：
- `20250514_add_fiscal_year_to_transactions.sql`
- `20250514_create_account_year_balances_table.sql`

## 迁移流程

1. **创建迁移文件**
   - 在本地 `supabase/migrations` 目录创建新的迁移文件
   - 使用上述命名规则
   - 确保迁移文件包含完整的SQL语句，包括所有必要的检查和约束

2. **测试迁移**
   - 在应用到生产环境之前，在本地或开发环境测试迁移
   - 确保迁移可以正确应用，并且不会破坏现有功能

3. **应用迁移**
   - 使用Supabase MCP服务器应用迁移
   - 记录迁移应用的时间和结果

4. **更新类型定义**
   - 应用迁移后，生成更新的TypeScript类型
   - 确保前端代码使用最新的类型定义

5. **更新文档**
   - 更新相关表的文档
   - 如果迁移包含新的函数或触发器，更新相应的函数文档

## 迁移验证

为确保本地迁移文件与实际数据库结构一致，建议定期执行以下验证：

1. **列出已应用的迁移**
   - 使用Supabase MCP服务器列出所有已应用的迁移
   - 确保所有本地迁移文件都已应用

2. **导出数据库结构**
   - 定期导出数据库结构
   - 将导出的结构与本地迁移文件进行比对

3. **解决不一致**
   - 如果发现不一致，创建新的迁移文件来解决
   - 记录不一致的原因和解决方案

## 回滚策略

虽然Supabase不直接支持迁移回滚，但我们可以采取以下策略：

1. **创建逆向迁移**
   - 对于每个迁移，考虑创建一个逆向迁移文件
   - 逆向迁移应能够撤销原迁移的所有更改

2. **数据备份**
   - 在应用重要迁移之前，备份数据库
   - 确保可以在必要时恢复到之前的状态

## 常见问题

1. **直接在Supabase控制台修改**
   - 问题：团队成员直接在Supabase控制台修改数据库结构
   - 解决：建立严格的流程，禁止直接修改；如果发生，立即创建对应的迁移文件

2. **迁移冲突**
   - 问题：多个开发者创建了冲突的迁移
   - 解决：使用日期前缀确保迁移顺序；协调团队避免同时修改相同的表
